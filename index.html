<div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-bold text-gray-900 dark:text-white">Résumé Mensuel (Dépenses)</h2>
    <button id="export-pdf-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">
        <i class="fas fa-file-pdf mr-2"></i> Exporter PDF
    </button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const exportBtn = document.getElementById('export-pdf-btn');
    if (exportBtn) {
        exportBtn.addEventListener('click', function () {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: "landscape",
                unit: "pt",
                format: "a4"
            });
            let y = 40;
            // Titre
            doc.setFontSize(22);
            doc.text('Résumé Statistiques Tesla', 40, y);
            // Résumé principal
            y += 30;
            doc.setFontSize(14);
            try {
                const totalCost = document.getElementById('total-cost')?.textContent || '';
                const totalKwh = document.getElementById('total-kwh')?.textContent || '';
                const avgCost = document.getElementById('avg-cost')?.textContent || '';
                doc.text(`Total dépensé : ${totalCost}`, 40, y);
                y += 20;
                doc.text(`Total kWh consommés : ${totalKwh}`, 40, y);
                y += 20;
                doc.text(`Coût moyen/kWh : ${avgCost}`, 40, y);
                y += 30;
            } catch {}
            // Tableau des stats mensuelles
            doc.setFontSize(16);
            doc.text('Dépenses Mensuelles', 40, y);
            y += 16;
            doc.setFontSize(10);
            // Parcourir le tableau
            const rows = [];
            document.querySelectorAll('#monthly-stats-body tr').forEach(tr => {
                const row = [];
                tr.querySelectorAll('td').forEach(td => row.push(td.textContent));
                rows.push(row);
            });
            // Headers
            doc.text('Mois', 40, y);
            doc.text('Coût (€)', 140, y);
            doc.text('kWh', 240, y);
            doc.text('€/kWh', 340, y);
            y += 12;
            // Lignes
            rows.forEach(row => {
                doc.text(row[0], 40, y);
                doc.text(row[1], 140, y);
                doc.text(row[2], 240, y);
                doc.text(row[3], 340, y);
                y += 12;
            });
            // Graphiques
            y += 20;
            doc.setFontSize(16);
            doc.text('Graphiques principaux', 40, y);
            y += 16;
            // Monthly Chart
            const monthlyCanvas = document.getElementById('monthly-chart');
            if (monthlyCanvas) {
                const imgData = monthlyCanvas.toDataURL('image/png', 1.0);
                doc.text('Dépenses Mensuelles', 40, y);
                doc.addImage(imgData, 'PNG', 40, y+10, 320, 120);
                y += 140;
            }
            // Station Chart
            const stationCanvas = document.getElementById('station-chart');
            if (stationCanvas) {
                const imgData = stationCanvas.toDataURL('image/png', 1.0);
                doc.text('Répartition par Borne', 40, y);
                doc.addImage(imgData, 'PNG', 40, y+10, 320, 120);
                y += 140;
            }
            // Efficiency Chart
            const efficiencyCanvas = document.getElementById('efficiency-chart');
            if (efficiencyCanvas) {
                const imgData = efficiencyCanvas.toDataURL('image/png', 1.0);
                doc.text('Efficacité (Km/kWh)', 40, y);
                doc.addImage(imgData, 'PNG', 40, y+10, 320, 120);
                y += 140;
            }
            doc.save('statistiques_tesla.pdf');
        });
    }
});
</script>
